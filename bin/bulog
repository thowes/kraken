#!/bin/bash
# bulog.sh: functions to manage backup log files.

# returns the last row of the backup log file.
bulog-latest() {
	if [ -f $1/backup.log ]; then
		KR_LATEST_BACKUP_LINE=$(tail -n 1 $1/backup.log)
		echo $KR_LATEST_BACKUP_LINE
	else
		touch $1/backup.log
		if [ -f $1/backup.log ]; then
			KR_NEW_BACKUP=$(date +"%F %R")
			echo $KR_NEW_BACKUP $2 ver $3 > $1/backup.log
		else
			virhe $1/backup.log cannot exist.
		fi
	fi
}

# returns the 2nd last row of the backup log file.
bulog_2nd_latest() {
	if [ "_$1_" == "__" ]; then
		BULOG_DIR=$(pwd)
	else
		BULOG_DIR=$1 
	fi
	if [ -f $BULOG_DIR/backup.log ]; then
		KRN_2ND_LATEST_LINE=$(tail -n 2 $BULOG_DIR/backup.log|head -n 1)
		echo $KRN_2ND_LATEST_LINE
	else
		virhe $BULOG_DIR/backup.log "doesn't exist."
	fi
}

# adds a line to the backup log file.
bulog_add() {
	#debug BULOG add $1 $2 $3
	if [ -f $1/backup.log ]; then
		# make a note in the log of new backup
		KR_NEW_BACKUP=$(date +"%F %R")
		echo $KR_NEW_BACKUP $2 ver $3 >> $1/backup.log
	else
		touch $1/backup.log
		if [ -f $1/backup.log ]; then
			KR_NEW_BACKUP=$(date +"%F %R")
			echo $KR_NEW_BACKUP $2 new $3 > $1/backup.log
		else
			virhe $1/backup.log is not a valid file.
		fi
	fi
}

bulog-today() {
	# Getting the last row of backup.log and splitting it to retrieve the part of the string for latest backup date.
	BU_LATEST_DATE=$(latest $1|awk '{print $1}')
	BU_TODAY_DATE=$(date +"%F")
	# Compare the date in latest line of backup.log, if not today, then continue. Doesn't do backup runs if already backed up today (checkup happens in bulog)
	if [ $BU_LATEST_DATE != $BU_TODAY_DATE ]; then
		echo "true"
	else
		echo "false"
	fi
}

if [ "_$1_" != "__" ]; then
	BULOG_NUM=1
	case $1 in
		-*) case $1 in
				-a*) BULOG_FUNCTION="bulog-add";;
				-t*) BULOG_FUNCTION="bulog-today";;
				*) BULOG_FUNCTION="bulog-latest"; case $1 in
					*:*) BULOG_NUM=$(echo $1|awk -F\: '{print $2}');;
				esac;;
			esac;;
		*) if [ -d $1/ ]; then if [ -f $1/backup.log ]; then BULOG_FUNCTION="bulog-latest"; BULOG_FILE=$1/; fi; else if [ -f $1 ]; then BULOG_FUNCTION="bulog-latest"; BULOG_FILE=$1; fi; fi;;
	esac
	if [ "_$2_" != "__" ]; then if [ -d $2/ ]; then if [ -f $2/backup.log ]; then BULOG_FILE=$2/; fi; else if [ -f $2 ]; then BULOG_FILE=$2; fi; fi; fi
else
	if [ -f "backup.log" ]; then BULOG_FUNCTION="bulog-latest"; BULOG_FILE="."; fi
fi
case $BULOG_FUNCTION in
	bulog-add) echo bulog-add $BULOG_FILE;;
	#bulog-latest) echo latest -n:$BULOG_NUM $BULOG_FILE;;
	bulog-latest) latest $BULOG_FILE;;
	bulog-today) echo bulog-today $BULOG_FILE;;
esac
