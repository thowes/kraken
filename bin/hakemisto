#!/bin/bash
if [ -d "$1" ]; then cd "$1"; fi
if [ -f changed.lst ]; then nada; else
	if [ -f changed.old ]; then mv changed.old changed.lst; fi
	if [ -f changed.log ]; then mv changed.log changed.lst; fi
fi
if [ -f duplicate.lst ]; then nada; else
	if [ -f duplicate.old ]; then mv duplicate.old duplicate.lst; fi
	if [ -f duplicate.log ]; then mv duplicate.log duplicate.lst; fi
fi
if [ -f hakemisto.lst ]; then nada; else
	if [ -f levy.old ]; then mv levy.old hakemisto.lst; fi
	if [ -f levy.log ]; then mv levy.log hakemisto.lst; fi
	if [ -f levy.lst ]; then mv levy.lst hakemisto.lst; fi
fi
if [ -f missing.lst ]; then nada; else
	if [ -f indb.lst ]; then mv indb.lst missing.lst; fi
fi
DIR="."; TEMP=$(asetus dir:temp); INIT_STRING="$HOSTNAME $(pwd) $(pvm)" #pvm=date +"%F %R"
KAYTTIS=$(kayttis)
if [ -z "$DB" ]; then DB="$(asetus path:db)"; fi
if [ -z "$TABLE" ]; then TABLE="$(asetus str:table)"; fi
echo $INIT_STRING > $TEMP/changed.lst
echo $INIT_STRING > $TEMP/duplicate.lst
echo $INIT_STRING > $TEMP/hakemisto.lst
echo $INIT_STRING > $TEMP/junk.lst
echo $INIT_STRING > $TEMP/missing.lst
ls -1R > $TEMP/ls.lst
while read p; do
	case $p in
		".:") DIR=".";;
		"./"*":"*) DIR=$(echo "$p"|awk -F':' '{ print $1 $2 }');; #\
		*"._"*) echo "$DIR/$p" >> $TEMP/junk.lst;;
		*"backup.log"*) nada;;
		*"changed.log"*) echo "$DIR/$p" >> $TEMP/junk.lst;;
		*"changed.lst"*) nada;;
		*"cover.jpg"*) echo "$DIR/$p" >> $TEMP/junk.lst;;
		*"cover.png"*) echo "$DIR/$p" >> $TEMP/junk.lst;;
		*".DS_Store"*) echo "$DIR/$p" >> $TEMP/junk.lst;; 
		*"duplicate.log"*) echo "$DIR/$p" >> $TEMP/junk.lst;;
		*"duplicate.lst"*) nada;;
		*"esktop.ini"*) echo "$DIR/$p" >> $TEMP/junk.lst;;
		*"hakemisto.lst"*) nada;;
		*"humbs.db"*) echo "$DIR/$p" >> $TEMP/junk.lst;;
		*"junk.lst"*) nada;;
		*"Icon"*) echo "$DIR/$p" >> $TEMP/junk.lst;;
		*"indb.lst"*) echo "$DIR/$p" >> $TEMP/junk.lst;;
		*"levy.log"*) echo "$DIR/$p" >> $TEMP/junk.lst;;
		*"levy.lst"*) echo "$DIR/$p" >> $TEMP/junk.lst;;
		*"LOCK"*) echo "$DIR/$p" >> $TEMP/junk.lst;;
		*"ls.lst"*) echo "$DIR/$p" >> $TEMP/junk.lst;;
		*"missing.lst"*) nada;;
		*"Notes.txt"*) echo "$DIR/$p" >> $TEMP/junk.lst;;
		"total "*) nada;;
		*)
			FILE_STATUS="OK"; FILE=$DIR/$(echo $p|awk -F'*' '{ print $1 }')
			case "$KAYTTIS" in
				darwin*) LS_TIME=$(gls -l --time-style=full-iso "$FILE"|awk '{print $6 "T" $7 $8 }');;
				* ) LS_TIME=$(ls --full-time "$FILE"|awk '{print $6 "T" $7 $8 }');;
			esac
			if [ -d "$FILE" ]; then nada; else
				SUMMA=$(summa "$FILE"); RIVI=$SUMMA,$FILE
				if [ "$(DB=$DB TABLE=$TABLE kannassa $FILE)" = "true" ]; then nada; else
					if [ "$FILE_STATUS" = "OK" ]; then FILE_STATUS="MM"; fi
					echo "$SUMMA,$FILE" >> $TEMP/missing.lst
				fi
				if [ -f hakemisto.lst ]; then
					RIVIT=$(cat hakemisto.lst | grep "$SUMMA" | grep -v "$RIVI" )
					if [ "$SUMMA,$FILE" = "$RIVIT" ]; then nada; else
						if [ "$LS_TIME,$SUMMA,$FILE" = "$RIVIT" ]; then nada; else
							if [ "$FILE_STATUS,$LS_TIME,$SUMMA,$FILE" = "$RIVIT" ]; then nada; else
								if [ "$FILE_STATUS" = "OK" ]; then FILE_STATUS="N2"; fi
								if [ "$FILE_STATUS" = "MM" ]; then FILE_STATUS="M2"; fi
								echo "$FILE_STATUS,$LS_TIME,$SUMMA,$FILE" >> $TEMP/duplicate.lst
							fi
						fi
					fi
				fi
				echo "$LS_TIME,$SUMMA,$FILE" >> $TEMP/hakemisto.lst
			fi;;
	esac
done < $TEMP/ls.lst
cp $TEMP/changed.lst ./changed.lst
cp $TEMP/duplicate.lst ./duplicate.lst
cp $TEMP/hakemisto.lst ./hakemisto.lst
cp $TEMP/junk.lst ./junk.lst
cp $TEMP/missing.lst ./missing.lst
if [ -f $TEMP/changed.lst ]; then rm $TEMP/changed.lst; fi
if [ -f $TEMP/duplicate.lst ]; then rm $TEMP/duplicate.lst; fi
if [ -f $TEMP/hakemisto.lst ]; then rm $TEMP/hakemisto.lst; fi
if [ -f $TEMP/junk.lst ]; then rm $TEMP/junk.lst; fi
if [ -f $TEMP/ls.lst ]; then rm $TEMP/ls.lst; fi
if [ -f $TEMP/missing.lst ]; then rm $TEMP/missing.lst; fi
if [ -f $TEMP/roskat.lst ]; then rm $TEMP/roskat.lst; fi
