#!/usr/bin/env ruby
# frozen_string_literal: true

require 'thor'
require 'fileutils'

# soita is finnish for 'play (something that produces sound)'.
class Soita < Thor
  class_option :verbose, type: :boolean, desc: 'use verbose mode.'
  # :verbose, type: :boolean, desc: 'use verbose mode.'
  default_task :default

  desc 'add PATH', 'add music file in PATH to playlist.'
  long_desc <<-LONGDESC
    `soita add` will add music file(s) in the PATH to playlist.
  LONGDESC
  def add(path = nil)
    File.open(playlist, 'a') do |pl|
      if Dir.exist?(path)
        puts "ADD DIR: #{path}" # if options[:verbose]
      elsif File.file?(path) && music?(path)
        puts "ADD: #{path}"
        pl.puts "\"#{File.expand_path(path)}\""
      elsif options[:verbose]
        puts "DO NOTHING (path not found): #{path}"
      end
    end
  end

  desc 'default PATH', 'add or play depending whether PATH included.'
  long_desc <<-LONGDESC
    `soita default` will do add or play depending whether PATH included.
  LONGDESC
  def default(path = nil)
    puts 'SOITA default' if options[:verbose]
    if path.nil?
      play
    else
      add(path)
    end
  end

  desc 'play PATH', 'play music in PATH.'
  long_desc <<-LONGDESC
    `soita play` will play music in PATH.
  LONGDESC
  def play(path = nil)
    add(path) unless path.nil?
    playlist_file = playlist
    puts "SOITA PLAY: playlist #{playlist_file}"
    File.readlines(playlist_file).each do |line|
      if music?(line)
        puts "PLAY: #{line}"
        system("afplay #{line}") if RUBY_PLATFORM.include?('darwin')
      end
    end
    File.delete(playlist_file) if File.exist?(playlist_file)
  end

  desc 'stop', 'stop playing music.'
  long_desc <<-LONGDESC
    `soita stop` will stop playing music.
  LONGDESC
  def stop(*)
    system('killall ruby "soita default"; killall afplay') if RUBY_PLATFORM.include?('darwin')
    system('killall ruby "soita default"; killall aplay') if RUBY_PLATFORM.include?('linux')
  end

  private

  def music?(path)
    return false if path.downcase.include?('._')
    # this doesn't cover situations where file endings include ".cue".
    return true if path.downcase.include?('.flac')
    return true if path.downcase.include?('.midi') # .ogg
    return true if path.downcase.include?('.mp3')
    return true if path.downcase.include?('.aac')
    return true if path.downcase.include?('.wav')

    false
  end

  def playlist
    temp_dir = `asetus dir:temp`.to_s || '~/Projects/temp'
    playlist_file = "#{temp_dir.strip}/playlist.lst"
    if File.file?(playlist_file)
      puts "PLAYLIST OK: #{playlist_file}" if options[:verbose]
    else
      puts "PLAYLIST NOT_OK: #{playlist_file}" if options[:verbose]
      FileUtils.touch(playlist_file)
    end
    playlist_file
  end

  def background
    # placeholder
  end
end

Soita.start(ARGV)
