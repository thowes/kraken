#!/usr/bin/env ruby
# frozen_string_literal: true

require 'thor'
require 'sqlite3'
require 'digest'

# HAKEMISTO class: scans contents of a dir and counts checksums.
class Hakemisto < Thor
  default_task :default

  desc 'default', 'default function.'
  def default(db_file = nil)
    new_db = database("#{temp}/#{db_file}") # check filename?
    # old = database(db_file) # pwd
    temp =  ENV['DB'] || system("asetus dir:temp") || '~/Projects/temp'
    insert = "INSERT INTO Documents (status, ls_time, summa, path) values"
    files.each do |f|
      md5 = Digest::MD5.file f
      summa_256 = Digest::SHA256.file f
      old.exec("#{select_line}='#{md5},#{s256}'")
      puts "new_db.exec" "#{insert} ('NA', '#{Time.now}', '#{md5},#{s256}', #{f}')") # read timestamp from file
    end
    db&.close
    # FileUtils.mv("#{temp}/hakemisto.db", db_file)
  end

  desc 'duplicate', 'look for duplicates in the DB.'
  def duplicate(filename = nil)
    db_file = db_file || ENV['DB'] || 'hakemisto.db'
    db = database(db_file) # non-changing
    if !filename.nil?
      md5 = Digest::MD5.file filename
      s256 = Digest::SHA256.file filename
      duplicate_lines(old, "#{md5},#{s256}")
    end
  end

  desc 'missing', 'look for missing files in the DB.'
  def missing
    #
  end

  private

  def database(filename = nil)
    insert = "CREATE TABLE IF NOT EXISTS Documents (status TEXT, ls_time DATETIME, summa TEXT, path TEXT)"
    file = "#{file}/hakemisto.db" if File.directory?(file) && !file.nil?
    db_file = 'hakemisto.db' if db_file.nil?
    db_return = SQLite3::Database.open file
    db_return(insert)
    db_return
  end
  def duplicate_lines(old_db, checksum)

    select_line = "SELECT * FROM Documents WHERE summa"
  end
end

Hakemisto.start(ARGV)
